# 重复任务功能 更新计划

## 设计目标

- 允许为任务配置可重复执行的提醒：每天/每周/每月/每年/自定义。
- 自定义支持精确到 年/月/日/时/分/秒 的周期组合（≥0，至少一项>0）。
- 可选结束时间（到达该日期的该时间后不再提醒），默认“无”；选择“无”时禁用日期与时分秒输入。
- 可选跳过规则：“每提醒A次跳过B次提醒”（A、B ≥ 0）。
- 即时保存：在重复设置窗口变更即保存，X 关闭不漏保存。
- 任务区左下角与任务表新增“重复”信息展示，遵循省略与格式规则。
- 记录重复次数：提醒一次+1，跳过不+1；编辑任务后清零。
- 不破坏现有功能与界面风格，兼容历史数据。

## 展示与省略规则

- 基本文案：“间隔<重复时间>重复提醒”
- 跳过规则已配置时：追加“，每提醒A次跳过B次提醒”
- 结束时间已配置时：追加“，直到<结束时间>”
- 结束时间显示逻辑：
    - 若结束年/月/日与系统当前对应项相同则省略该项
    - 秒为 0 则不显示秒
    - 时间始终 24 小时制，格式 H:mm
    - 例：系统为 2025/8/20
        - 结束 2025/8/21 21:30:00 → “21日21:30”
        - 结束 2025/9/1 01:00:00 → “9月1日1:00”
- 任务表“剩余时间”之后新增“重复”列
    - 普通任务显示“不重复”
    - 重复任务显示与任务区左下角一致，并在末尾追加“，已重复N次”（N>0 时显示）

## 数据结构设想

- TaskItem 新增：
    - RepeatSpec: 可空/或含 Mode 字段的对象
    - RepeatCount: int（初始0；提醒+1；跳过不+1；编辑任务后清0）
- RepeatSpec
    - Mode: None/Daily/Weekly/Monthly/Yearly/Custom
    - Custom: Years/Months/Days/Hours/Minutes/Seconds（≥0，至少一项>0）
    - EndAt: 可空 DateTime（超过该时刻不再提醒）
    - SkipRule: 可空对象 { RemindTimes: int A, SkipTimes: int B }
- JSON 序列化兼容：老数据默认 Mode=None

## 兼容性与风格

- 保持“事件驱动、变更即保存”的交互一致性
- UI 风格、尺寸、间距与现有窗口保持一致
- 历史数据无需迁移脚本即可加载

---

## 任务拆分（按阶段逐步交付）

- × P0 计划制定与方案冻结
    - 梳理需求、数据结构与展示规则
    - 确认拆分与风险点

- × P1 数据模型与序列化
    - 在 `Core/Models/TaskItem` 新增 `RepeatSpec`、`RepeatCount`
    - 定义 `RepeatMode`、`RepeatCustom`、`SkipRule`
    - JSON 序列化/反序列化默认兼容（无重复→None）
    - 不改变既有字段与行为

- × P2 主界面：任务操作区新增“重复”按钮
    - 放置在“添加”按钮旁边
    - 点击弹出“重复设置”窗口
    - 与现有 UI 风格对齐

- × P3 重复设置窗口（UI）
    - 单选：每天/每周/每月/每年/自定义
    - 自定义周期输入：年/月/日/时/分/秒（≥0，至少一项>0）
    - 结束时间：日期选择（同创建任务）+ 时间选择（时/分/秒，默认系统时间）
    - 跳过提醒：“每提醒A次，跳过B次”
    - 交互约束：当重复时间为空时禁用结束时间与跳过输入
    - 现状：已提供确定/取消对话框；事件驱动的“变更即保存”将在 P4 实现

- × P4 重复设置窗口（保存逻辑）
    - 变更即保存：任一控件变更→发布事件→主窗体更新并持久化
    - X 关闭不丢失修改；目前暂保留“确定/取消”按钮但仅作关闭用途
    - 已实现 250ms 防抖，避免高频保存；包含异常保护

- × P5 主窗体集成（应用与回填）
    - 打开窗口时回填当前任务的 `RepeatSpec`
    - 事件中立即更新任务、保存任务、刷新 UI
    - 任意编辑任务字段后 `RepeatCount` 清零

- × P6 任务区左下角展示
    - 新增标签，实时显示重复信息
    - 严格执行省略与格式规则

- × P7 任务表列扩展
    - 在“剩余时间”之后新增“重复”列
    - 普通任务“不重复”；重复任务按规则显示
    - 若 `RepeatCount>0`：追加“，已重复N次”

- × P8 提醒与调度逻辑（含跳过）
    - 到点触发：若处于“跳过阶段”→不提醒且不+1；否则提醒并 `RepeatCount+1`
    - 计算下一次提醒时间：按 Mode 或自定义周期累加
    - 超过 EndAt 则不再提醒
    - 与现有排序/剩余时间刷新兼容

- × P9 校验与边界
   - 自定义周期至少一项>0（全为0则视为不重复）
   - 结束时间不可为过去（将被忽略并在窗口以红字提示）
   - 跳过规则需 A>0 且 B>0 才会生效
   - 当 Mode==None 时不记录 EndAt/SkipRule
   - 超过 EndAt 后当前策略：自动停止重复并置为“不重复”（RepeatCount 保留）

- P10 回归与文档
    - 覆盖示例用例（含展示字符串示例）
    - README 与 “更新内容.md”更新
    - 手动测试清单与已知限制
    - 手动回归测试清单：
        - 默认行为：打开窗口时“结束时间”勾选“无”，日期/时/分/秒禁用。
        - 选择“无”：保存后 RepeatSpec.EndAt 为 null；展示文案不包含“截止…”。
        - 取消“无”：可编辑日期/时/分/秒；设置未来时间→保存写入 EndAt；设置过去时间→红字提示且不写入。
        - 模式切换：Daily/Weekly/Monthly/Yearly/Custom（非零）保持上述行为一致；Custom 全为 0 或 Mode=None 时，结束时间与跳过规则禁用。
        - 跳过规则：A>0 且 B>0 时生效；其它情况仅提示不生效，不报错。
        - 回填验证：已有 EndAt 的 RepeatSpec 回填后自动取消“无”勾选；无 EndAt 的保持“无”。
        - 展示验证：列表“重复”列与状态栏在 HasEnd 时追加“截止 <时间>”；EndAt 为空时不追加；RepeatCount>0 时追加“已重复N次”。
        - 调度验证：EndAt 为空→持续按周期提醒；超过 EndAt→停止重复并置为不重复（RepeatCount 保留）。
        - 未设置结束时间时，展示文案不包含“截止…”，且不影响重复提醒的正常进行。

---

## 验收清单

- 可配置周期（标准与自定义）
- 可配置结束时间（展示省略规则正确；未设置时视为“无”，不显示“截止…”）
- 可配置跳过规则（运行时正确跳过且不+1）
- 任务区与表格“重复”列展示正确
- 重复次数记录准确，编辑后清零
- 即时保存无丢失，X 关闭不漏保存
- 老数据“非重复”不受影响